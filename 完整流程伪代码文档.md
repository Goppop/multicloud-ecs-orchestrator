# 多云ECS调度框架 - 完整流程伪代码文档

> 本文记录当前项目计划对接多云厂商提供对C服务 。作为多云对接器连接多云厂商和业务层的架构设计阶段性版本 因本人对(多)云服务技术和概念理解可能还有缺漏 后面会继续调查 更新该文档
>
>  以下包含从业务层调用到实例创建的完整流程和方法调用链

---

## 目录

1. [业务层调用入口](#1-业务层调用入口)
2. [统一服务层处理](#2-统一服务层处理)
3. [调度器选择云厂商](#3-调度器选择云厂商)
4. [云厂商客户端处理](#4-云厂商客户端处理)
5. [网络资源管理](#5-网络资源管理)
6. [参数映射](#6-参数映射)
7. [实例创建](#7-实例创建)
8. [网络打通](#8-网络打通)
9. [价格计算](#9-价格计算)
10. [完整调用链图](#10-完整调用链图)

---

## 1. 业务层调用入口

```java
// ============================================
// 业务层代码示例
// ============================================

@Service
public class OrderInstanceService {
    
    @Autowired
    private MultiCloudEcsService multiCloudEcsService;
    
    /**
     * 创建AI算力实例
     */
    public VirtualMachine createAiComputeInstance(Order order) {
        
        // 1.1 构建创建请求（声明式模型，无需指定厂商特定ID）
        CreateInstanceRequest request = CreateInstanceRequest.builder()
                .provider("ALIYUN")                    // 指定云厂商
                .tenantId(order.getTenantId())         // 租户ID（用于资源隔离和成本分摊）
                .userId(order.getUserId())             // 用户ID（用于网络隔离，静默寻址）
                .instanceName("ai-compute-" + order.getOrderId())
                .region("cn-hangzhou")                 // 区域
                .imageKey("pytorch-1.12")              // 业务镜像标识（必填，驱动层自动映射为ImageId）
                .gpuModel("A100")                      // GPU型号（可选，驱动层自动映射为InstanceType）
                .systemDiskSize(100)                   // 系统盘大小(GB)
                .systemDiskType("cloud_essd")          // 系统盘类型
                .allocatePublicIp(true)                // 需要公网IP
                .publicIpBandwidth(10)                 // 公网带宽(Mbps)
                .bandwidthMode(BandwidthMode.TRAFFIC)  // 带宽计费模式：TRAFFIC(按流量) 或 FIXED(固定带宽)
                .openPorts(Arrays.asList(22, 80, 443, 8888))  // 需要开放的端口
                .password("SecurePassword@123")         // 实例密码
                .instanceChargeMode(InstanceChargeMode.ON_DEMAND)  // 实例计费模式：ON_DEMAND(按需) 或 PREPAID(预付费)
                .duration(null)                        // 预付费时长（月），按需付费时无需设置
                .tags(Map.of(
                    "env", "production",
                    "project", "ai-platform",
                    "orderId", order.getOrderId()
                ))
                .build();
        
        // 1.2 调用统一服务创建实例
        VirtualMachine vm = multiCloudEcsService.createInstance(request);
        
        // 1.3 保存实例信息到数据库
        saveInstanceToDb(order, vm);
        
        return vm;
    }
}
```

---

## 2. 统一服务层处理

```java
// ============================================
// MultiCloudEcsServiceImpl.createInstance()
// ============================================

@Service
public class MultiCloudEcsServiceImpl implements MultiCloudEcsService {
    
    private final CloudEcsClientRegistry registry;      // 客户端注册中心
    private final EcsScheduler scheduler;                // 调度器
    private final TenantTagInjector tenantTagInjector;   // 标签注入器
    
    @Override
    public VirtualMachine createInstance(CreateInstanceRequest request) throws EcsException {
        
        // ========== 步骤1: 参数校验 ==========
        validateCreateRequest(request);
        // 校验内容：
        //   - request != null
        //   - tenantId 不为空
        //   - userId 不为空
        //   - instanceName 不为空
        //   - region 不为空
        //   - imageKey 不为空（已移除废弃的imageId字段）
        //   - provider 不为空（V1版本要求）
        
        // ========== 步骤2: 注入租户标签 ==========
        tenantTagInjector.inject(request);
        // 执行逻辑：
        //   - 获取或创建 tags Map
        //   - 注入 tenantId 标签: tags.put("tenantId", request.getTenantId())
        //   - 注入 userId 标签: tags.put("Owner", request.getUserId())
        //   - 注入创建来源标签: tags.put("createdBy", "multicloud-ecs")
        
        // ========== 步骤3: 调度选择云厂商 ==========
        CloudEcsClient client = scheduler.select(request);
        // 调度器会：
        //   - 从 request.getProvider() 获取云厂商代码
        //   - 从 registry 中获取对应的客户端
        //   - 检查客户端是否可用
        //   - 返回选中的客户端
        
        log.info("创建实例开始: provider={}, instanceName={}, tenantId={}, region={}",
                client.getProviderCode(), request.getInstanceName(), 
                request.getTenantId(), request.getRegion());
        
        try {
            // ========== 步骤4: 调用云厂商API创建实例 ==========
            VirtualMachine vm = client.createInstance(request);
            // 这里会调用 AliyunEcsClient.createInstance()
            // 详见第4节
            
            // ========== 步骤5: 补充响应信息 ==========
            if (vm.getProvider() == null) {
                vm.setProvider(client.getProviderCode());
            }
            if (vm.getTenantId() == null) {
                vm.setTenantId(request.getTenantId());
            }
            
            log.info("创建实例成功: provider={}, instanceId={}, instanceName={}, status={}",
                    vm.getProvider(), vm.getInstanceId(), vm.getInstanceName(), vm.getStatus());
            return vm;
            
        } catch (EcsException e) {
            log.error("创建实例失败: provider={}, instanceName={}, error={}",
                    client.getProviderCode(), request.getInstanceName(), e.getMessage());
            throw e;
        } catch (Exception e) {
            log.error("创建实例异常: provider={}, instanceName={}",
                    client.getProviderCode(), request.getInstanceName(), e);
            throw new EcsException(client.getProviderCode(), "CREATE_FAILED", 
                    "创建实例异常: " + e.getMessage(), e);
        }
    }
    
    /**
     * 校验创建请求参数
     */
    private void validateCreateRequest(CreateInstanceRequest request) throws EcsException {
        if (request == null) {
            throw EcsException.of("VALIDATION", "REQUEST_NULL", "创建请求不能为空");
        }
        if (request.getTenantId() == null || request.getTenantId().trim().isEmpty()) {
            throw EcsException.of("VALIDATION", "TENANT_ID_REQUIRED", "租户ID不能为空");
        }
        if (request.getUserId() == null || request.getUserId().trim().isEmpty()) {
            throw EcsException.of("VALIDATION", "USER_ID_REQUIRED", "用户ID不能为空");
        }
        if (request.getInstanceName() == null || request.getInstanceName().trim().isEmpty()) {
            throw EcsException.of("VALIDATION", "INSTANCE_NAME_REQUIRED", "实例名称不能为空");
        }
        if (request.getRegion() == null || request.getRegion().trim().isEmpty()) {
            throw EcsException.of("VALIDATION", "REGION_REQUIRED", "区域不能为空");
        }
        // 检查镜像标识（已移除废弃的imageId字段）
        if (request.getImageKey() == null || request.getImageKey().trim().isEmpty()) {
            throw EcsException.of("VALIDATION", "IMAGE_REQUIRED", "镜像标识(imageKey)不能为空");
        }
        // V1版本必须指定provider
        if (scheduler.requireProvider() && 
                (request.getProvider() == null || request.getProvider().trim().isEmpty())) {
            throw EcsException.of("VALIDATION", "PROVIDER_REQUIRED", 
                    "当前调度策略(" + scheduler.getName() + ")要求必须指定云厂商代码");
        }
    }
}
```

---

## 3. 调度器选择云厂商

```java
// ============================================
// FixedScheduler.select()
// ============================================

@Component
public class FixedScheduler implements EcsScheduler {
    
    private final CloudEcsClientRegistry registry;
    
    @Override
    public CloudEcsClient select(CreateInstanceRequest request) throws EcsException {
        
        // ========== 步骤1: 校验provider是否指定 ==========
        String provider = request.getProvider();
        if (provider == null || provider.trim().isEmpty()) {
            throw EcsException.of("SCHEDULER", "PROVIDER_REQUIRED",
                    "V1版本必须指定云厂商代码(provider字段)");
        }
        
        // ========== 步骤2: 从注册中心获取对应的客户端 ==========
        CloudEcsClient client = registry.getClient(provider);
        // registry.getClient() 执行逻辑：
        //   - 标准化 providerCode（转大写）
        //   - 从 ConcurrentHashMap 中查找: clients.get(providerCode)
        //   - 如果不存在，抛出 EcsException("PROVIDER_NOT_FOUND")
        //   - 返回找到的客户端
        
        // ========== 步骤3: 检查客户端是否可用 ==========
        if (!client.isAvailable()) {
            throw EcsException.of("SCHEDULER", "PROVIDER_UNAVAILABLE",
                    "云厂商客户端不可用: " + provider);
        }
        
        log.debug("FixedScheduler 选择云厂商: provider={}, clientClass={}",
                provider, client.getClass().getSimpleName());
        
        return client;
    }
}
```

---

## 4. 云厂商客户端处理

```java
// ============================================
// AliyunEcsClient.createInstance()
// 继承 AbstractCloudEcsClient，复用通用逻辑
// ============================================

public class AliyunEcsClient extends AbstractCloudEcsClient {
    
    private final AliyunEcsProperties properties;
    private final AliyunNetworkManager networkManager;      // 网络资源管理器
    private final AliyunParameterMapper parameterMapper;   // 参数映射器
    
    // AbstractCloudEcsClient 已处理：
    //   - 参数校验（validateCreateRequest）
    //   - 标签注入（injectTenantTags）
    //   - 日志打印（logCreateInstanceStart/Success/Error）
    //   - 异常处理（统一包装为EcsException）
    
    @Override
    protected VirtualMachine doCreateInstance(CreateInstanceRequest request) throws EcsException {
        String region = resolveRegion(request);
        String userId = request.getUserId();
        
        try {
            // ========== 步骤1: 静默寻址（透明网络供应）==========
            // 如果Request里只有tenantId，自动查找或创建VPC和交换机
            AliyunNetworkManager.NetworkResources networkResources = 
                    networkManager.ensureNetworkResources(
                        userId, 
                        region, 
                        request.getZone(), 
                        request.getTags() != null ? request.getTags() : new HashMap<>()
                    );
            // 详见第5节：网络资源管理
            
            log.info("[AliyunEcsClient] 网络资源准备完成（静默寻址）: vpcId={}, vSwitchId={}, securityGroupId={}",
                    networkResources.getVpcId(), networkResources.getVSwitchId(), 
                    networkResources.getSecurityGroupId());
            
            // ========== 步骤2: 参数映射 ==========
            // 将 imageKey 映射为 ImageId
            String imageId = parameterMapper.resolveImageId(null, request.getImageKey());
            // 详见第6节：参数映射
            
            // 将 gpuModel 映射为 InstanceType（如果指定了gpuModel）
            String instanceType = parameterMapper.resolveInstanceType(
                    request.getInstanceType(), 
                    request.getGpuModel()
            );
            // 详见第6节：参数映射
            
            log.info("[AliyunEcsClient] 参数映射完成: imageKey={} -> imageId={}, gpuModel={} -> instanceType={}",
                    request.getImageKey(), imageId, request.getGpuModel(), instanceType);
            
            // ========== 步骤3: 计费模式映射 ==========
            // 将统一的计费模式映射为阿里云计费模式
            String instanceChargeType = mapInstanceChargeMode(request.getInstanceChargeMode());
            // ON_DEMAND -> PostPaid
            // PREPAID -> PrePaid
            
            String internetChargeType = mapBandwidthMode(request.getBandwidthMode());
            // TRAFFIC -> PayByTraffic
            // FIXED -> PayByBandwidth
            
            log.info("[AliyunEcsClient] 计费模式映射: instanceChargeMode={} -> {}, bandwidthMode={} -> {}",
                    request.getInstanceChargeMode(), instanceChargeType,
                    request.getBandwidthMode(), internetChargeType);
            
            // ========== 步骤4: 创建实例 ==========
            // TODO: 阿里云SDK接入后实现
            // 详见第7节：实例创建
            
            String instanceId = "i-" + System.currentTimeMillis();  // 模拟数据
            String requestId = "req-" + System.currentTimeMillis();
            
            // ========== 步骤5: 网络打通（异步）==========
            // 详见第8节：网络打通
            
            // ========== 步骤6: 构建返回结果 ==========
            Map<String, Object> metadata = new HashMap<>();
            metadata.put("vpcId", networkResources.getVpcId());
            metadata.put("vSwitchId", networkResources.getVSwitchId());
            metadata.put("securityGroupId", networkResources.getSecurityGroupId());
            metadata.put("instanceChargeType", instanceChargeType);
            metadata.put("internetChargeType", internetChargeType);
            
            return VirtualMachine.builder()
                    .instanceId(instanceId)
                    .instanceName(request.getInstanceName())
                    .status(VmStatusEnum.PENDING)
                    .provider(getProviderCode())
                    .region(region)
                    .instanceType(instanceType)
                    .imageId(imageId)
                    .publicIp(publicIp)  // 从异步操作获取
                    .tenantId(request.getTenantId())
                    .tags(request.getTags())
                    .metadata(metadata)  // 包含网络资源和计费信息
                    .build();
                    
        } catch (EcsException e) {
            throw e;
        } catch (Exception e) {
            throw new EcsException(getProviderCode(), "CREATE_FAILED",
                    "创建实例失败: " + e.getMessage(), e);
        }
    }
    
    /**
     * 将统一的实例计费模式映射为阿里云计费模式
     */
    private String mapInstanceChargeMode(InstanceChargeMode mode) {
        if (mode == null) {
            return "PostPaid"; // 默认按量付费
        }
        switch (mode) {
            case ON_DEMAND:
                return "PostPaid";
            case PREPAID:
                return "PrePaid";
            default:
                return "PostPaid";
        }
    }
    
    /**
     * 将统一的带宽计费模式映射为阿里云计费模式
     */
    private String mapBandwidthMode(BandwidthMode mode) {
        if (mode == null) {
            return "PayByTraffic"; // 默认按流量计费
        }
        switch (mode) {
            case TRAFFIC:
                return "PayByTraffic";
            case FIXED:
                return "PayByBandwidth";
            default:
                return "PayByTraffic";
        }
    }
}
```

---

## 5. 网络资源管理

```java
// ============================================
// AliyunNetworkManager.ensureNetworkResources()
// ============================================

@Component
public class AliyunNetworkManager {
    
    /**
     * 确保用户拥有独立的网络资源（幂等操作）
     */
    public NetworkResources ensureNetworkResources(
            String userId, 
            String region, 
            String zone, 
            Map<String, String> tags
    ) throws EcsException {
        
        log.info("[AliyunNetworkManager] 开始确保网络资源: userId={}, region={}, zone={}", 
                userId, region, zone);
        
        try {
            // ========== 步骤1: 查找是否存在带有 Owner: {userId} 标签的VPC ==========
            String existingVpcId = findVpcByUserTag(userId, region);
            // findVpcByUserTag() 执行逻辑：
            //   - 构建 DescribeVpcsRequest
            //   - 设置 TagKey="Owner", TagValue=userId
            //   - 调用阿里云API查询
            //   - 如果找到且状态为"Available"，返回vpcId
            //   - 否则返回null
            
            if (existingVpcId != null) {
                log.info("[AliyunNetworkManager] 找到已存在的VPC: vpcId={}, userId={}", 
                        existingVpcId, userId);
                
                // ========== 复用现有VPC ==========
                return findExistingNetworkResources(existingVpcId, userId, region, zone);
                // findExistingNetworkResources() 执行逻辑：
                //   - 查找VSwitch: DescribeVSwitchesRequest (vpcId, zoneId)
                //   - 查找SecurityGroup: DescribeSecurityGroupsRequest (vpcId, Owner标签)
                //   - 返回 NetworkResources(vpcId, vSwitchId, securityGroupId)
            }
            
            // ========== 步骤2: VPC不存在，需要创建 ==========
            log.info("[AliyunNetworkManager] VPC不存在，开始创建: userId={}", userId);
            return createNetworkResources(userId, region, zone, tags);
            // createNetworkResources() 执行逻辑：
            //   详见下方
            
        } catch (Exception e) {
            // 处理配额错误
            if (e.getMessage() != null && e.getMessage().contains("QuotaExceeded")) {
                throw EcsException.of(properties.getProviderCode(), "QUOTA_EXCEEDED",
                        "网络资源配额不足，无法创建VPC/VSwitch/SecurityGroup: " + e.getMessage());
            }
            throw new EcsException(properties.getProviderCode(), "NETWORK_CREATE_FAILED",
                    "创建网络资源失败: " + e.getMessage(), e);
        }
    }
    
    /**
     * 创建网络资源（VPC -> VSwitch -> SecurityGroup）
     */
    private NetworkResources createNetworkResources(
            String userId, 
            String region, 
            String zone, 
            Map<String, String> tags
    ) throws EcsException {
        
        // ========== 步骤1: 计算CIDR网段 ==========
        String cidrBlock = calculateCidrBlock(userId);
        // calculateCidrBlock() 执行逻辑：
        //   - 基于userId的hash值计算
        //   - 从172.16.0.0/12中分配独立网段
        //   - 返回格式: "172.X.Y.0/24"
        
        // ========== 步骤2: 创建VPC ==========
        CreateVpcRequest vpcRequest = new CreateVpcRequest();
        vpcRequest.setRegionId(region);
        vpcRequest.setCidrBlock(cidrBlock);
        vpcRequest.setVpcName("vpc-" + userId);
        vpcRequest.setDescription("Auto-created VPC for user: " + userId);
        
        // 设置标签（包含tenantId和userId）
        List<CreateVpcRequest.Tag> vpcTags = new ArrayList<>();
        for (Map.Entry<String, String> tag : tags.entrySet()) {
            CreateVpcRequest.Tag vpcTag = new CreateVpcRequest.Tag();
            vpcTag.setKey(tag.getKey());
            vpcTag.setValue(tag.getValue());
            vpcTags.add(vpcTag);
        }
        vpcRequest.setTags(vpcTags);
        
        CreateVpcResponse vpcResponse = client.getAcsResponse(vpcRequest);
        String vpcId = vpcResponse.getVpcId();
        log.info("[AliyunNetworkManager] VPC创建成功: vpcId={}, userId={}", vpcId, userId);
        
        // ========== 步骤3: 创建VSwitch ==========
        CreateVSwitchRequest vswRequest = new CreateVSwitchRequest();
        vswRequest.setVpcId(vpcId);
        vswRequest.setZoneId(zone != null ? zone : getDefaultZone(region));
        vswRequest.setCidrBlock(calculateVSwitchCidr(cidrBlock));
        vswRequest.setVSwitchName("vsw-" + userId);
        
        // 设置标签
        List<CreateVSwitchRequest.Tag> vswTags = new ArrayList<>();
        for (Map.Entry<String, String> tag : tags.entrySet()) {
            CreateVSwitchRequest.Tag vswTag = new CreateVSwitchRequest.Tag();
            vswTag.setKey(tag.getKey());
            vswTag.setValue(tag.getValue());
            vswTags.add(vswTag);
        }
        vswRequest.setTags(vswTags);
        
        CreateVSwitchResponse vswResponse = client.getAcsResponse(vswRequest);
        String vSwitchId = vswResponse.getVSwitchId();
        log.info("[AliyunNetworkManager] VSwitch创建成功: vSwitchId={}, userId={}", vSwitchId, userId);
        
        // ========== 步骤4: 创建SecurityGroup ==========
        CreateSecurityGroupRequest sgRequest = new CreateSecurityGroupRequest();
        sgRequest.setVpcId(vpcId);
        sgRequest.setSecurityGroupName("sg-" + userId);
        sgRequest.setDescription("Auto-created SecurityGroup for user: " + userId);
        
        // 设置标签
        List<CreateSecurityGroupRequest.Tag> sgTags = new ArrayList<>();
        for (Map.Entry<String, String> tag : tags.entrySet()) {
            CreateSecurityGroupRequest.Tag sgTag = new CreateSecurityGroupRequest.Tag();
            sgTag.setKey(tag.getKey());
            sgTag.setValue(tag.getValue());
            sgTags.add(sgTag);
        }
        sgRequest.setTags(sgTags);
        
        CreateSecurityGroupResponse sgResponse = client.getAcsResponse(sgRequest);
        String securityGroupId = sgResponse.getSecurityGroupId();
        log.info("[AliyunNetworkManager] SecurityGroup创建成功: securityGroupId={}, userId={}", 
                securityGroupId, userId);
        
        return new NetworkResources(vpcId, vSwitchId, securityGroupId, cidrBlock);
    }
}
```

---

## 6. 参数映射

```java
// ============================================
// AliyunParameterMapper
// ============================================

@Component
public class AliyunParameterMapper {
    
    // 镜像Key到ImageId的映射表
    private static final Map<String, String> IMAGE_KEY_MAPPING = new HashMap<>();
    static {
        IMAGE_KEY_MAPPING.put("centos-7.9", "centos_7_9_x64_20G_alibase_20220824.vhd");
        IMAGE_KEY_MAPPING.put("ubuntu-20.04", "ubuntu_20_04_x64_20G_alibase_20220824.vhd");
        IMAGE_KEY_MAPPING.put("pytorch-1.12", "pytorch_1_12_cuda11_3_ubuntu20_04");
        IMAGE_KEY_MAPPING.put("tensorflow-2.8", "tensorflow_2_8_cuda11_2_ubuntu20_04");
    }
    
    // GPU型号到实例类型的映射表
    private static final Map<String, String> GPU_MODEL_MAPPING = new HashMap<>();
    static {
        GPU_MODEL_MAPPING.put("A100", "ecs.gn7i-c8g1.2xlarge");
        GPU_MODEL_MAPPING.put("V100", "ecs.gn6i-c4g1.xlarge");
        GPU_MODEL_MAPPING.put("T4", "ecs.gn6i-c4g1.xlarge");
    }
    
    /**
     * 解析镜像ID（优先使用imageKey映射，最后使用默认值）
     * 注意：已移除废弃的imageId参数
     */
    public String resolveImageId(String imageId, String imageKey) {
        // 1. 如果指定了imageKey，映射为imageId
        if (imageKey != null && !imageKey.trim().isEmpty()) {
            return mapImageKeyToImageId(imageKey);
            // mapImageKeyToImageId() 执行逻辑：
            //   - 从 IMAGE_KEY_MAPPING 中查找: mapping.get(imageKey.toLowerCase())
            //   - 如果找到，返回映射的ImageId
            //   - 如果未找到，使用默认镜像或直接使用imageKey
        }
        
        // 2. 使用默认镜像ID
        return properties.getDefaultImageId();
    }
    
    /**
     * 解析实例类型（优先使用gpuModel映射，其次使用instanceType，最后使用默认值）
     */
    public String resolveInstanceType(String instanceType, String gpuModel) {
        // 1. 如果指定了instanceType，直接使用
        if (instanceType != null && !instanceType.trim().isEmpty()) {
            return instanceType;
        }
        
        // 2. 如果指定了gpuModel，映射为instanceType
        if (gpuModel != null && !gpuModel.trim().isEmpty()) {
            String mappedType = mapGpuModelToInstanceType(gpuModel);
            // mapGpuModelToInstanceType() 执行逻辑：
            //   - 从 GPU_MODEL_MAPPING 中查找: mapping.get(gpuModel.toUpperCase())
            //   - 如果找到，返回映射的InstanceType
            //   - 如果未找到，使用默认实例类型
            if (mappedType != null) {
                return mappedType;
            }
        }
        
        // 3. 使用默认实例类型
        return properties.getDefaultInstanceType();
    }
}
```

---

## 7. 实例创建

```java
// ============================================
// AliyunEcsClient.createInstance() - 步骤3
// ============================================

// ========== 步骤3.1: 创建阿里云SDK客户端 ==========
DefaultProfile profile = DefaultProfile.getProfile(
    region,
    properties.getAccessKeyId(),
    properties.getAccessKeySecret()
);
IAcsClient client = new DefaultAcsClient(profile);

// ========== 步骤3.2: 构建 RunInstancesRequest ==========
RunInstancesRequest runRequest = new RunInstancesRequest();
runRequest.setRegionId(region);
runRequest.setZoneId(request.getZone() != null ? request.getZone() : getDefaultZone(region));
runRequest.setInstanceType(instanceType);  // 从参数映射获取
runRequest.setImageId(imageId);            // 从参数映射获取
runRequest.setSecurityGroupId(networkResources.getSecurityGroupId());  // 从网络资源获取
runRequest.setVSwitchId(networkResources.getVSwitchId());              // 从网络资源获取
runRequest.setInstanceName(request.getInstanceName());
runRequest.setSystemDiskCategory(resolveSystemDiskCategory(request));
runRequest.setSystemDiskSize(resolveSystemDiskSize(request));
runRequest.setPassword(request.getPassword());

// 不分配公网IP（稍后通过EIP绑定）
runRequest.setInternetMaxBandwidthOut(0);

// ========== 步骤3.3: 设置标签 ==========
List<RunInstancesRequest.Tag> instanceTags = new ArrayList<>();
if (request.getTags() != null) {
    for (Map.Entry<String, String> tag : request.getTags().entrySet()) {
        RunInstancesRequest.Tag instanceTag = new RunInstancesRequest.Tag();
        instanceTag.setKey(tag.getKey());
        instanceTag.setValue(tag.getValue());
        instanceTags.add(instanceTag);
    }
}
runRequest.setTags(instanceTags);

// ========== 步骤3.4: 调用API创建实例 ==========
RunInstancesResponse response = client.getAcsResponse(runRequest);
String instanceId = response.getInstanceIdSets().get(0);
String requestId = response.getRequestId();

log.info("[AliyunEcsClient] 实例创建成功: instanceId={}, requestId={}", instanceId, requestId);
```

---

## 8. 网络打通

```java
// ============================================
// AliyunEcsClient.createInstance() - 步骤4
// ============================================

// ========== 步骤4.1: 异步申请并绑定EIP ==========
CompletableFuture<String> eipFuture = null;
if (request.getAllocatePublicIp() != null && request.getAllocatePublicIp()) {
    eipFuture = networkManager.allocateAndBindEip(instanceId, region);
    // allocateAndBindEip() 执行逻辑：
    //   详见下方
}

// ========== 步骤4.2: 异步添加安全组规则 ==========
CompletableFuture<Void> sgRulesFuture = null;
if (request.getOpenPorts() != null && !request.getOpenPorts().isEmpty()) {
    sgRulesFuture = networkManager.addSecurityGroupRules(
            networkResources.getSecurityGroupId(),
            request.getOpenPorts(),
            region
    );
    // addSecurityGroupRules() 执行逻辑：
    //   详见下方
}

// ========== 步骤4.3: 等待异步操作完成 ==========
String publicIp = null;
if (eipFuture != null) {
    try {
        publicIp = eipFuture.get(); // 等待EIP绑定完成
        log.info("[AliyunEcsClient] EIP绑定完成: instanceId={}, publicIp={}", instanceId, publicIp);
    } catch (Exception e) {
        log.error("[AliyunEcsClient] EIP绑定失败: instanceId={}, error={}", instanceId, e.getMessage());
        // EIP绑定失败不影响实例创建，记录日志即可
    }
}

if (sgRulesFuture != null) {
    try {
        sgRulesFuture.get(); // 等待安全组规则添加完成
        log.info("[AliyunEcsClient] 安全组规则添加完成: instanceId={}, ports={}", 
                instanceId, request.getOpenPorts());
    } catch (Exception e) {
        log.error("[AliyunEcsClient] 安全组规则添加失败: instanceId={}, error={}", 
                instanceId, e.getMessage());
        // 安全组规则添加失败不影响实例创建，记录日志即可
    }
}

// ============================================
// AliyunNetworkManager.allocateAndBindEip()
// ============================================
public CompletableFuture<String> allocateAndBindEip(String instanceId, String region) {
    return CompletableFuture.supplyAsync(() -> {
        log.info("[AliyunNetworkManager] 开始申请EIP: instanceId={}, region={}", instanceId, region);
        
        try {
            // 1. 申请EIP
            AllocateEipAddressRequest allocateRequest = new AllocateEipAddressRequest();
            allocateRequest.setRegionId(region);
            allocateRequest.setBandwidth("10"); // 默认10Mbps
            AllocateEipAddressResponse allocateResponse = client.getAcsResponse(allocateRequest);
            String allocationId = allocateResponse.getAllocationId();
            String eipAddress = allocateResponse.getEipAddress();
            
            log.info("[AliyunNetworkManager] EIP申请成功: allocationId={}, eipAddress={}", 
                    allocationId, eipAddress);
            
            // 2. 绑定到实例
            AssociateEipAddressRequest associateRequest = new AssociateEipAddressRequest();
            associateRequest.setAllocationId(allocationId);
            associateRequest.setInstanceId(instanceId);
            associateRequest.setInstanceType("EcsInstance");
            AssociateEipAddressResponse associateResponse = client.getAcsResponse(associateRequest);
            
            log.info("[AliyunNetworkManager] EIP绑定成功: instanceId={}, eipAddress={}", 
                    instanceId, eipAddress);
            return eipAddress;
            
        } catch (Exception e) {
            log.error("[AliyunNetworkManager] EIP申请/绑定失败: instanceId={}, error={}", 
                    instanceId, e.getMessage());
            throw new RuntimeException("EIP申请/绑定失败: " + e.getMessage(), e);
        }
    });
}

// ============================================
// AliyunNetworkManager.addSecurityGroupRules()
// ============================================
public CompletableFuture<Void> addSecurityGroupRules(
        String securityGroupId, 
        List<Integer> ports, 
        String region
) {
    return CompletableFuture.runAsync(() -> {
        if (ports == null || ports.isEmpty()) {
            return;
        }
        
        log.info("[AliyunNetworkManager] 开始添加安全组规则: securityGroupId={}, ports={}", 
                securityGroupId, ports);
        
        for (Integer port : ports) {
            try {
                AuthorizeSecurityGroupRequest request = new AuthorizeSecurityGroupRequest();
                request.setSecurityGroupId(securityGroupId);
                request.setRegionId(region);
                request.setIpProtocol("tcp");
                request.setPortRange(port + "/" + port);
                request.setSourceCidrIp("0.0.0.0/0");
                request.setDescription("Auto-opened port for AI compute platform");
                
                AuthorizeSecurityGroupResponse response = client.getAcsResponse(request);
                log.info("[AliyunNetworkManager] 安全组规则添加成功: securityGroupId={}, port={}", 
                        securityGroupId, port);
            } catch (Exception e) {
                // 如果规则已存在，忽略错误（幂等性）
                if (!e.getMessage().contains("InvalidPermission.Duplicate")) {
                    log.error("[AliyunNetworkManager] 添加安全组规则失败: securityGroupId={}, port={}, error={}",
                            securityGroupId, port, e.getMessage());
                }
            }
        }
    });
}
```

---

## 9. 价格计算

```java
// ============================================
// AliyunEcsClient.calculatePrice()
// 用于订单系统在创建实例前获取报价
// ============================================

@Override
public PriceInfo calculatePrice(CreateInstanceRequest request) throws EcsException {
    log.info("[AliyunEcsClient] 计算价格: instanceName={}, instanceType={}, region={}",
            request.getInstanceName(), request.getInstanceType(), request.getRegion());
    
    try {
        // 1. 解析参数
        String region = resolveRegion(request);
        String instanceType = parameterMapper.resolveInstanceType(
                request.getInstanceType(),
                request.getGpuModel()
        );
        
        // 2. 计费模式映射
        String instanceChargeType = mapInstanceChargeMode(request.getInstanceChargeMode());
        String internetChargeType = mapBandwidthMode(request.getBandwidthMode());
        
        /*
         * TODO: 阿里云SDK接入后实现
         * 
         * // 调用阿里云价格查询API
         * DescribePriceRequest priceRequest = new DescribePriceRequest();
         * priceRequest.setRegionId(region);
         * priceRequest.setInstanceType(instanceType);
         * priceRequest.setImageId(parameterMapper.resolveImageId(null, request.getImageKey()));
         * priceRequest.setSystemDiskCategory(resolveSystemDiskCategory(request));
         * priceRequest.setSystemDiskSize(resolveSystemDiskSize(request));
         * priceRequest.setInstanceChargeType(instanceChargeType);
         * 
         * if (request.getAllocatePublicIp() != null && request.getAllocatePublicIp()) {
         *     priceRequest.setInternetChargeType(internetChargeType);
         *     priceRequest.setInternetMaxBandwidthOut(request.getPublicIpBandwidth() != null ? 
         *             request.getPublicIpBandwidth() : 5);
         * }
         * 
         * DescribePriceResponse response = client.getAcsResponse(priceRequest);
         * 
         * // 构建PriceInfo
         * return PriceInfo.builder()
         *         .provider(getProviderCode())
         *         .region(region)
         *         .instanceType(instanceType)
         *         .instancePricePerHour(new BigDecimal(response.getPriceInfo().getPrice()))
         *         .totalPricePerHour(new BigDecimal(response.getPriceInfo().getTradePrice()))
         *         .currency("CNY")
         *         .queryTimestamp(System.currentTimeMillis())
         *         .priceValiditySeconds(3600L)
         *         .build();
         */
        
        // 临时模拟：返回模拟价格
        return PriceInfo.builder()
                .provider(getProviderCode())
                .region(region)
                .instanceType(instanceType)
                .instancePricePerHour(new BigDecimal("0.5"))
                .instancePricePerMonth(new BigDecimal("300"))
                .systemDiskPricePerGbPerMonth(new BigDecimal("0.1"))
                .bandwidthPricePerMbpsPerMonth(new BigDecimal("23"))
                .trafficPricePerGb(new BigDecimal("0.8"))
                .totalPricePerHour(new BigDecimal("0.6"))
                .totalPricePerMonth(new BigDecimal("400"))
                .currency("CNY")
                .queryTimestamp(System.currentTimeMillis())
                .priceValiditySeconds(3600L)
                .build();
                
    } catch (Exception e) {
        log.error("[AliyunEcsClient] 计算价格失败: instanceName={}, error={}",
                request.getInstanceName(), e.getMessage(), e);
        throw new EcsException(getProviderCode(), "CALCULATE_PRICE_FAILED",
                "计算价格失败: " + e.getMessage(), e);
    }
}
```

### 9.1 订单系统调用示例

```java
@Service
public class OrderPriceService {
    
    @Autowired
    private MultiCloudEcsService multiCloudEcsService;
    
    /**
     * 计算订单价格
     */
    public PriceInfo calculateOrderPrice(Order order) {
        // 构建创建请求（与创建实例时相同）
        CreateInstanceRequest request = CreateInstanceRequest.builder()
                .provider("ALIYUN")
                .tenantId(order.getTenantId())
                .userId(order.getUserId())
                .instanceName("preview-" + order.getOrderId())
                .region("cn-hangzhou")
                .imageKey("pytorch-1.12")
                .gpuModel("A100")
                .systemDiskSize(100)
                .allocatePublicIp(true)
                .publicIpBandwidth(10)
                .bandwidthMode(BandwidthMode.TRAFFIC)
                .instanceChargeMode(InstanceChargeMode.ON_DEMAND)
                .build();
        
        // 调用统一服务计算价格（内部会路由到对应的云厂商客户端）
        PriceInfo priceInfo = multiCloudEcsService.calculatePrice(request);
        
        return priceInfo;
    }
}
```

---

## 10. 完整调用链图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        完整调用链：从业务层到实例创建                          	 │
└─────────────────────────────────────────────────────────────────────────────┘

业务层
  │
  │ 1. OrderInstanceService.createAiComputeInstance()
  │    └─> 构建 CreateInstanceRequest
  │        {
  │          "provider": "ALIYUN",                    // 云厂商代码，如：ALIYUN, SCC, TENCENT
  │          "region": "cn-hangzhou",                // 区域/Region，如：cn-hangzhou, cn-shanghai
  │          "zone": "cn-hangzhou-g",                // 可用区/Zone，如：cn-hangzhou-g
  │          "tenantId": "tenant-001",               // 租户ID
  │          "userId": "user-001",                   // 用户ID
  │          "instanceName": "ai-compute-001",       // 实例名称
  │          "instanceType": null,                   // 规格类型，如：ecs.g7.large, sl.medium.2
  │          "imageKey": "pytorch-1.12",            // 业务镜像标识（必填），如：centos-7.9, ubuntu-20.04, pytorch-1.12
  │          "gpuModel": "A100",                     // GPU型号需求，如：A100, V100, T4
  │          "cpu": null,                            // CPU核数
  │          "memory": null,                         // 内存大小(GB)
  │          "systemDiskSize": 100,                  // 系统盘大小(GB)
  │          "systemDiskType": "cloud_essd",         // 系统盘类型，如：cloud_ssd, cloud_efficiency
  │          "allocatePublicIp": true,               // 是否分配公网IP，默认false
  │          "openPorts": [22, 80, 443, 8888],       // 需要开放的端口列表
  │          "publicIpBandwidth": 10,                // 公网带宽(Mbps)
  │          "bandwidthMode": "TRAFFIC",             // 带宽计费模式：TRAFFIC(按流量) 或 FIXED(固定带宽)
  │          "password": "SecurePassword@123",       // 密码
  │          "keyPairName": null,                     // 密钥对名称
  │          "instanceChargeMode": "ON_DEMAND",      // 实例计费模式：ON_DEMAND(按需) 或 PREPAID(预付费)
  │          "duration": null,                       // 时长（预付费模式时使用，单位：月）
  │          "quantity": 1,                         // 数量，默认1
  │          "description": null,                    // 描述/备注
  │          "tags": {                              // 标签（框架会自动注入tenantId、Owner、createdBy）
  │            "env": "production",
  │            "project": "ai-platform",
  │            "orderId": "order-001"
  │          },
  │          "extensions": null                      // 扩展参数
  │        }
  │
  ▼
统一服务层 (MultiCloudEcsServiceImpl)
  │
  │ 2. createInstance(request)
  │    │
  │    ├─> 2.1 validateCreateRequest(request)
  │    │       └─> 校验必填参数
  │    │
  │    ├─> 2.2 tenantTagInjector.inject(request)
  │    │       └─> 注入标签: tenantId, Owner(userId), createdBy
  │    │
  │    ├─> 2.3 scheduler.select(request)
  │    │       │
  │    │       ▼
  │    │   调度器层 (FixedScheduler)
  │    │       │
  │    │       3. select(request)
  │    │          │
  │    │          ├─> 3.1 校验 provider 是否指定
  │    │          │
  │    │          ├─> 3.2 registry.getClient(provider)
  │    │          │       │
  │    │          │       ▼
  │    │          │   注册中心 (CloudEcsClientRegistry)
  │    │          │       │
  │    │          │       4. getClient(providerCode)
  │    │          │          └─> 从 ConcurrentHashMap 查找客户端
  │    │          │
  │    │          └─> 3.3 检查 client.isAvailable()
  │    │
  │    └─> 2.4 client.createInstance(request)
  │            │
  │            ▼
  │        云厂商客户端层 (AliyunEcsClient extends AbstractCloudEcsClient)
  │            │
  │            5. createInstance(request) [继承自AbstractCloudEcsClient]
  │               │
  │               ├─> 5.0.1 validateCreateRequest() [AbstractCloudEcsClient]
  │               ├─> 5.0.2 injectTenantTags() [AbstractCloudEcsClient]
  │               ├─> 5.0.3 logCreateInstanceStart() [AbstractCloudEcsClient]
  │               │
  │               ├─> 5.1 doCreateInstance(request) [子类实现]
  │               │       │
  │               │       ├─> 5.1.1 networkManager.ensureNetworkResources() [静默寻址]
  │               │       │       │   // 如果Request里只有tenantId，自动查找或创建VPC和交换机
  │               │       │       │
  │               │       │       ▼
  │               │       │   网络资源管理器 (AliyunNetworkManager)
  │               │       │       │
  │               │       │       6. ensureNetworkResources(userId, region, zone, tags)
  │               │       │          │
  │               │       │          ├─> 6.1 findVpcByUserTag(userId, region)
  │               │       │          │       └─> 查询是否存在 Owner: {userId} 的VPC
  │               │       │          │
  │               │       │          ├─> 6.2 如果存在: findExistingNetworkResources()
  │               │       │          │       └─> 查找 VSwitch 和 SecurityGroup
  │               │       │          │
  │               │       │          └─> 6.3 如果不存在: createNetworkResources()
  │               │       │                  │
  │               │       │                  ├─> 6.3.1 计算CIDR网段
  │               │       │                  ├─> 6.3.2 创建VPC (CreateVpcRequest)
  │               │       │                  ├─> 6.3.3 创建VSwitch (CreateVSwitchRequest)
  │               │       │                  └─> 6.3.4 创建SecurityGroup (CreateSecurityGroupRequest)
  │               │       │
  │               │       ├─> 5.1.2 parameterMapper.resolveImageId(null, imageKey)
  │               │       │       │   // 注意：已移除废弃的imageId参数
  │               │       │       │
  │               │       │       ▼
  │               │       │   参数映射器 (AliyunParameterMapper)
  │               │       │       │
  │               │       │       7. resolveImageId(null, imageKey)
  │               │       │          └─> mapImageKeyToImageId(imageKey)
  │               │       │              └─> 从 IMAGE_KEY_MAPPING 查找映射
  │               │       │
  │               │       ├─> 5.1.3 parameterMapper.resolveInstanceType()
  │               │       │       │
  │               │       │       ▼
  │               │       │   参数映射器 (AliyunParameterMapper)
  │               │       │       │
  │               │       │       8. resolveInstanceType(instanceType, gpuModel)
  │               │       │          └─> mapGpuModelToInstanceType(gpuModel)
  │               │       │              └─> 从 GPU_MODEL_MAPPING 查找映射
  │               │       │
  │               │       ├─> 5.1.4 计费模式映射
  │               │       │       ├─> mapInstanceChargeMode() [ON_DEMAND -> PostPaid, PREPAID -> PrePaid]
  │               │       │       └─> mapBandwidthMode() [TRAFFIC -> PayByTraffic, FIXED -> PayByBandwidth]
  │               │       │
  │               │       ├─> 5.1.5 创建实例 (RunInstancesRequest)
  │               │       │       │
  │               │       │       ├─> 创建 IAcsClient
  │               │       │       ├─> 构建 RunInstancesRequest
  │               │       │       │   - instanceType: "ecs.gn7i-c8g1.2xlarge"
  │               │       │       │   - imageId: "pytorch_1_12_cuda11_3_ubuntu20_04"
  │               │       │       │   - securityGroupId: "sg-user-001"
  │               │       │       │   - vSwitchId: "vsw-user-001"
  │               │       │       │   - instanceChargeType: "PostPaid" [从计费模式映射]
  │               │       │       │   - internetChargeType: "PayByTraffic" [从带宽模式映射]
  │               │       │       └─> 调用 client.getAcsResponse(runRequest)
  │               │       │
  │               │       ├─> 5.1.6 网络打通（异步）
  │               │       │       │
  │               │       │       ├─> 5.1.6.1 allocateAndBindEip(instanceId, region)
  │               │       │       │       │
  │               │       │       │       ├─> AllocateEipAddressRequest (申请EIP)
  │               │       │       │       └─> AssociateEipAddressRequest (绑定EIP)
  │               │       │       │
  │               │       │       └─> 5.1.6.2 addSecurityGroupRules(securityGroupId, ports, region)
  │               │       │               │
  │               │       │               └─> AuthorizeSecurityGroupRequest (添加端口规则)
  │               │       │                   - 遍历 openPorts: [22, 80, 443, 8888]
  │               │       │                   - 为每个端口添加入站规则
  │               │       │
  │               │       └─> 5.1.7 构建 VirtualMachine 响应
  │               │               - instanceId
  │               │               - publicIp (从异步操作获取)
  │               │               - metadata (包含网络资源和计费信息)
  │               │
  │               ├─> 5.2 logCreateInstanceSuccess() [AbstractCloudEcsClient]
  │
  ▼
返回 VirtualMachine 给业务层
```

---

## 11. 关键方法清单

### 11.1 业务层
- `OrderInstanceService.createAiComputeInstance()` - 业务入口
- `OrderPriceService.calculateOrderPrice()` - 价格计算入口

### 11.2 统一服务层
- `MultiCloudEcsServiceImpl.createInstance()` - 统一服务入口
- `MultiCloudEcsServiceImpl.calculatePrice()` - 价格计算入口
- `MultiCloudEcsServiceImpl.validateCreateRequest()` - 参数校验
- `TenantTagInjector.inject()` - 标签注入

### 11.3 调度器层
- `FixedScheduler.select()` - 选择云厂商客户端
- `CloudEcsClientRegistry.getClient()` - 获取客户端

### 11.4 云厂商客户端层
- `AbstractCloudEcsClient.createInstance()` - 创建实例主流程（通用逻辑）
- `AbstractCloudEcsClient.validateCreateRequest()` - 参数校验（通用逻辑）
- `AbstractCloudEcsClient.injectTenantTags()` - 标签注入（通用逻辑）
- `AbstractCloudEcsClient.calculatePrice()` - 价格计算（默认抛出未实现异常）
- `AbstractCloudEcsClient.logCreateInstanceStart()` - 记录创建开始日志（通用逻辑）
- `AbstractCloudEcsClient.logCreateInstanceSuccess()` - 记录创建成功日志（通用逻辑）
- `AbstractCloudEcsClient.logCreateInstanceError()` - 记录创建错误日志（通用逻辑）
- `AliyunEcsClient.doCreateInstance()` - 创建实例具体实现（子类实现）
- `AliyunEcsClient.calculatePrice()` - 价格计算具体实现（子类实现）
- `AliyunEcsClient.mapInstanceChargeMode()` - 实例计费模式映射（ON_DEMAND -> PostPaid, PREPAID -> PrePaid）
- `AliyunEcsClient.mapBandwidthMode()` - 带宽计费模式映射（TRAFFIC -> PayByTraffic, FIXED -> PayByBandwidth）
- `AliyunEcsClient.resolveRegion()` - 解析区域

### 10.5 网络资源管理
- `AliyunNetworkManager.ensureNetworkResources()` - 确保网络资源（主入口）
- `AliyunNetworkManager.findVpcByUserTag()` - 查找VPC
- `AliyunNetworkManager.findExistingNetworkResources()` - 查找现有网络资源
- `AliyunNetworkManager.createNetworkResources()` - 创建网络资源
- `AliyunNetworkManager.calculateCidrBlock()` - 计算CIDR网段
- `AliyunNetworkManager.allocateAndBindEip()` - 申请并绑定EIP
- `AliyunNetworkManager.addSecurityGroupRules()` - 添加安全组规则

### 10.6 参数映射
- `AliyunParameterMapper.resolveImageId()` - 解析镜像ID
- `AliyunParameterMapper.resolveInstanceType()` - 解析实例类型
- `AliyunParameterMapper.mapImageKeyToImageId()` - 映射镜像Key
- `AliyunParameterMapper.mapGpuModelToInstanceType()` - 映射GPU型号

---

## 12. 数据流转

```
CreateInstanceRequest (输入)
  │
  ├─> 参数校验
  ├─> 标签注入
  │   └─> tags: {tenantId, Owner, createdBy}
  │
  ├─> 调度器选择
  │   └─> CloudEcsClient (AliyunEcsClient)
  │
  ├─> 网络资源管理
  │   └─> NetworkResources {vpcId, vSwitchId, securityGroupId}
  │
  ├─> 参数映射
  │   ├─> imageKey -> imageId
  │   ├─> gpuModel -> instanceType
  │   ├─> instanceChargeMode -> instanceChargeType (ON_DEMAND -> PostPaid, PREPAID -> PrePaid)
  │   └─> bandwidthMode -> internetChargeType (TRAFFIC -> PayByTraffic, FIXED -> PayByBandwidth)
  │
  ├─> 实例创建
  │   └─> instanceId, requestId
  │
  ├─> 网络打通（异步）
  │   ├─> EIP绑定 -> publicIp
  │   └─> 安全组规则 -> 端口开放
  │
  └─> VirtualMachine (输出)
      ├─> instanceId
      ├─> publicIp
      ├─> metadata {vpcId, vSwitchId, securityGroupId, instanceChargeType, internetChargeType}
      └─> tags {tenantId, Owner, createdBy}
```

---

## 13. 异常处理流程

```
异常类型                   处理位置                    错误码
─────────────────────────────────────────────────────────────
参数校验失败    AbstractCloudEcsClient.validateCreateRequest()  VALIDATION_*
调度器选择失败   FixedScheduler.select()                  SCHEDULER_*
网络资源配额     AliyunNetworkManager.createNetworkResources()   QUOTA_EXCEEDED
网络创建失败     AliyunNetworkManager.createNetworkResources()   NETWORK_CREATE_FAILED
实例创建失败     AliyunEcsClient.doCreateInstance()        CREATE_FAILED
价格计算失败     AliyunEcsClient.calculatePrice()          CALCULATE_PRICE_FAILED
EIP绑定失败      AliyunNetworkManager.allocateAndBindEip()       记录日志，不影响主流程
安全组规则失败   AliyunNetworkManager.addSecurityGroupRules()    记录日志，不影响主流程
```

---



